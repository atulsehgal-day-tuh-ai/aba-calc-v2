<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ABA Medical Necessity Calculator â€” System Architecture</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

  :root {
    --primary: #0B6FA4;
    --primary-light: #E1F0FA;
    --primary-hover: #085A85;
    --secondary: #00897B;
    --secondary-light: #E0F2F1;
    --success: #2E7D32;
    --success-light: #E8F5E9;
    --warning: #EF8C00;
    --warning-light: #FFF3E0;
    --critical: #C62828;
    --critical-light: #FFEBEE;
    --heading: #1B2A4A;
    --subheading: #2D3748;
    --body: #334155;
    --secondary-text: #64748B;
    --placeholder: #94A3B8;
    --border: #E2E8F0;
    --bg: #F0F4F8;
    --card: #FFFFFF;
    --sidebar: #1B2A4A;
  }

  @page { size: A4 landscape; margin: 1.5cm; }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
    color: var(--body);
    background: #fff;
    line-height: 1.6;
    max-width: 1100px;
    margin: 0 auto;
    padding: 2rem 3rem;
  }

  h1 { font-size: 2rem; color: var(--heading); margin-bottom: 0.25rem; }
  h1 span { color: var(--primary); }
  .subtitle { color: var(--secondary-text); font-size: 1rem; margin-bottom: 2rem; border-bottom: 2px solid var(--border); padding-bottom: 1rem; }
  h2 { font-size: 1.35rem; color: var(--primary); margin: 2rem 0 1rem; padding-bottom: 0.4rem; border-bottom: 2px solid var(--primary-light); }
  h3 { font-size: 1.1rem; color: var(--subheading); margin: 1.2rem 0 0.6rem; }
  p, li { font-size: 0.92rem; }
  ul { padding-left: 1.5rem; margin-bottom: 0.8rem; }
  li { margin-bottom: 0.3rem; }
  code { background: var(--bg); padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.85rem; color: #7c3aed; }

  /* Diagram containers */
  .diagram-box { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin: 1rem 0 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.06); overflow-x: auto; }

  /* Architecture tiers */
  .arch-grid { display: grid; gap: 1rem; }
  .tier { border-radius: 10px; padding: 1rem 1.2rem; }
  .tier-label { font-weight: 700; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.6rem; }
  .tier-client { background: var(--primary-light); border: 2px solid #90CAF9; }
  .tier-client .tier-label { color: var(--primary); }
  .tier-api { background: var(--secondary-light); border: 2px solid #80CBC4; }
  .tier-api .tier-label { color: var(--secondary); }
  .tier-data { background: var(--warning-light); border: 2px solid #FFD54F; }
  .tier-data .tier-label { color: #A16207; }
  .tier-infra { background: #F3E8FF; border: 2px solid #D8B4FE; }
  .tier-infra .tier-label { color: #7E22CE; }

  .boxes { display: flex; flex-wrap: wrap; gap: 0.6rem; }
  .box { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem 0.8rem; font-size: 0.82rem; min-width: 120px; }
  .box strong { display: block; font-size: 0.78rem; color: var(--heading); }
  .box span { font-size: 0.72rem; color: var(--secondary-text); }

  .flow-arrow { text-align: center; color: var(--placeholder); font-size: 1.4rem; margin: 0.3rem 0; }

  /* Table */
  table { width: 100%; border-collapse: collapse; margin: 0.8rem 0; font-size: 0.85rem; }
  th { background: var(--bg); color: var(--secondary-text); font-weight: 600; text-align: left; padding: 0.6rem 0.8rem; border-bottom: 2px solid var(--border); font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.5px; }
  td { padding: 0.5rem 0.8rem; border-bottom: 1px solid var(--border); vertical-align: top; }
  tr:last-child td { border-bottom: none; }
  tr:nth-child(even) td { background: #F7FAFC; }

  /* File tree */
  .file-tree { font-family: 'Cascadia Code', 'Fira Code', Consolas, monospace; font-size: 0.8rem; background: var(--sidebar); color: #e2e8f0; padding: 1.2rem; border-radius: 10px; line-height: 1.7; }
  .file-tree .dir { color: #60a5fa; }
  .file-tree .file { color: #a5b4fc; }
  .file-tree .comment { color: #64748b; }

  /* Steps */
  .flow-step { display: flex; align-items: flex-start; gap: 0.8rem; margin: 0.6rem 0; }
  .step-num { background: linear-gradient(135deg, var(--primary), #0E87C7); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 0.78rem; font-weight: 700; flex-shrink: 0; }
  .step-content { flex: 1; }
  .step-content strong { color: var(--primary); }

  /* Layout */
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
  @media (max-width: 768px) { .two-col { grid-template-columns: 1fr; } }

  /* Tags */
  .tag { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
  .tag-react { background: var(--primary-light); color: var(--primary); }
  .tag-ts { background: #E0E7FF; color: #4338CA; }
  .tag-node { background: var(--secondary-light); color: var(--secondary); }
  .tag-db { background: var(--warning-light); color: #854D0E; }
  .tag-vercel { background: #F3E8FF; color: #7E22CE; }

  /* Print */
  @media print {
    body { background: white; padding: 0; max-width: none; }
    .diagram-box { break-inside: avoid; box-shadow: none; }
    .tier { break-inside: avoid; }
    h2 { break-after: avoid; }
  }
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<h1>ABA Medical Necessity Calculator â€” <span>System Architecture</span></h1>
<p class="subtitle">End-to-End Technical Architecture Document &bull; Demo Prototype &bull; v2.0 &bull; February 2026</p>

<!-- ===== 1. HIGH-LEVEL OVERVIEW ===== -->
<h2>1. High-Level System Overview</h2>
<p>The ABA Medical Necessity Calculator is a <strong>dual-tenant, full-stack web application</strong> with two distinct user portals (Clinic and Insurance) sharing a common API backend and database.</p>

<div class="diagram-box">
  <div class="arch-grid">
    <div class="tier tier-client">
      <div class="tier-label">ğŸŒ Client Tier â€” Browser</div>
      <div class="boxes">
        <div class="box"><strong>LoginScreen</strong><span>Role selection (Clinic / Insurance)</span></div>
        <div class="box"><strong>Clinic Portal</strong><span>Calculator, Claims, Insights</span></div>
        <div class="box"><strong>Insurance Portal</strong><span>Queue, Policy Calc, Decisions, Config</span></div>
        <div class="box"><strong>Shared Components</strong><span>Layout, Field, Badge, Meter, etc.</span></div>
        <div class="box"><strong>Zustand Stores</strong><span>authStore, claimStore</span></div>
        <div class="box"><strong>Core Libraries</strong><span>calculator.ts, mlPredictor.ts, api.ts</span></div>
      </div>
    </div>

    <div class="flow-arrow">â¬‡ HTTP REST (JSON) via fetch &nbsp;|&nbsp; /api/* â¬‡</div>

    <div class="tier tier-api">
      <div class="tier-label">âš™ï¸ API Tier â€” Express.js Server</div>
      <div class="boxes">
        <div class="box"><strong>Express App</strong><span>CORS, JSON middleware</span></div>
        <div class="box"><strong>/api/claims</strong><span>GET, POST, PATCH</span></div>
        <div class="box"><strong>/api/patients</strong><span>GET, POST</span></div>
        <div class="box"><strong>/api/analytics</strong><span>GET (aggregations)</span></div>
        <div class="box"><strong>/api/payer-profiles</strong><span>GET, PUT</span></div>
        <div class="box"><strong>/api/health</strong><span>Health check</span></div>
      </div>
    </div>

    <div class="flow-arrow">â¬‡ Tri-Mode DB Client (async interface) â¬‡</div>

    <div class="tier tier-data">
      <div class="tier-label">ğŸ’¾ Data Tier â€” SQLite / Turso</div>
      <div class="boxes">
        <div class="box"><strong>patients</strong><span>id, name, age, diagnosis, settings</span></div>
        <div class="box"><strong>claims</strong><span>id, patient, status, assessment, calc, ml</span></div>
        <div class="box"><strong>payer_profiles</strong><span>id, name, weights, multipliers, ranges</span></div>
        <div class="box"><strong>audit_log</strong><span>entity_type, action, details, user_role</span></div>
      </div>
    </div>

    <div class="flow-arrow">â¬‡ Deployment Target â¬‡</div>

    <div class="tier tier-infra">
      <div class="tier-label">â˜ï¸ Infrastructure Tier â€” Vercel + Turso</div>
      <div class="boxes">
        <div class="box"><strong>Vercel CDN</strong><span>Static React build (dist/)</span></div>
        <div class="box"><strong>Vercel Serverless</strong><span>api/index.ts â†’ Express handler</span></div>
        <div class="box"><strong>Turso Cloud</strong><span>libSQL â€” remote SQLite (if configured)</span></div>
        <div class="box"><strong>In-Memory libSQL</strong><span>Serverless demo mode (no Turso)</span></div>
        <div class="box"><strong>Local Dev</strong><span>better-sqlite3 file: aba.db</span></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== 2. TECHNOLOGY STACK ===== -->
<h2>2. Technology Stack</h2>
<div class="two-col">
  <div>
    <h3>Frontend</h3>
    <table>
      <tr><td><strong>Framework</strong></td><td>React 19 <span class="tag tag-react">React</span></td></tr>
      <tr><td><strong>Build Tool</strong></td><td>Vite 7</td></tr>
      <tr><td><strong>Language</strong></td><td>TypeScript <span class="tag tag-ts">TS</span></td></tr>
      <tr><td><strong>Styling</strong></td><td>Tailwind CSS 4 + Custom CSS design system</td></tr>
      <tr><td><strong>State Mgmt</strong></td><td>Zustand</td></tr>
      <tr><td><strong>Icons</strong></td><td>Lucide React</td></tr>
      <tr><td><strong>Font</strong></td><td>Inter (Google Fonts)</td></tr>
      <tr><td><strong>Routing</strong></td><td>Role-based conditional rendering</td></tr>
    </table>
  </div>
  <div>
    <h3>Backend</h3>
    <table>
      <tr><td><strong>Runtime</strong></td><td>Node.js <span class="tag tag-node">Node</span></td></tr>
      <tr><td><strong>Framework</strong></td><td>Express.js</td></tr>
      <tr><td><strong>Language</strong></td><td>TypeScript (tsx runner)</td></tr>
      <tr><td><strong>DB (Local)</strong></td><td>better-sqlite3 <span class="tag tag-db">SQLite</span></td></tr>
      <tr><td><strong>DB (Cloud)</strong></td><td>@libsql/client (Turso)</td></tr>
      <tr><td><strong>DB (Demo)</strong></td><td>@libsql/client :memory:</td></tr>
      <tr><td><strong>Hosting</strong></td><td>Vercel Serverless <span class="tag tag-vercel">Vercel</span></td></tr>
      <tr><td><strong>IDs</strong></td><td>uuid v4</td></tr>
    </table>
  </div>
</div>

<!-- ===== 3. PROJECT STRUCTURE ===== -->
<h2>3. Project File Structure</h2>
<div class="diagram-box">
<div class="file-tree">
<span class="dir">aba-calc-v2/</span><br>
â”œâ”€â”€ <span class="dir">api/</span> <span class="comment">................... Vercel serverless entry point</span><br>
â”‚&nbsp;&nbsp; â””â”€â”€ <span class="file">index.ts</span> <span class="comment">............ Express handler wrapper (cold-start DB init)</span><br>
â”œâ”€â”€ <span class="dir">server/</span> <span class="comment">................. Backend API</span><br>
â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">index.ts</span> <span class="comment">............ Express app + server bootstrap</span><br>
â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="dir">db/</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">index.ts</span> <span class="comment">........ Tri-mode DbClient (Turso / in-memory / better-sqlite3)</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">schema.ts</span> <span class="comment">....... CREATE TABLE statements (4 tables)</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ <span class="file">seed.ts</span> <span class="comment">......... Demo data seeder (5 patients, 3 profiles, 4 claims)</span><br>
â”‚&nbsp;&nbsp; â””â”€â”€ <span class="dir">routes/</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”œâ”€â”€ <span class="file">claims.ts</span> <span class="comment">....... CRUD + status workflow</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”œâ”€â”€ <span class="file">patients.ts</span> <span class="comment">..... CRUD</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”œâ”€â”€ <span class="file">analytics.ts</span> <span class="comment">.... Aggregate statistics</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â””â”€â”€ <span class="file">payerProfiles.ts</span> <span class="comment"> Read + update payer configs</span><br>
â”œâ”€â”€ <span class="dir">src/</span> <span class="comment">.................... Frontend React app</span><br>
â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">main.tsx</span> <span class="comment">............ React DOM entry</span><br>
â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">App.tsx</span> <span class="comment">............. Role-based routing (Login â†’ Clinic | Insurance)</span><br>
â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">index.css</span> <span class="comment">........... Tailwind + CSS design system (colors, typography, etc.)</span><br>
â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">vite-env.d.ts</span> <span class="comment">....... Vite type declarations</span><br>
â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="dir">lib/</span> <span class="comment">................ Core business logic (client-side)</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">calculator.ts</span> <span class="comment">... 7-step dosage determination engine</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">mlPredictor.ts</span> <span class="comment">.. Simulated ML approval predictor</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ <span class="file">api.ts</span> <span class="comment">.......... REST API client (fetch wrapper)</span><br>
â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="dir">stores/</span> <span class="comment">............. Zustand state management</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">authStore.ts</span> <span class="comment">.... Role state (clinic | insurance | null)</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ <span class="file">claimStore.ts</span> <span class="comment">... Claims list + CRUD actions</span><br>
â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="dir">components/</span> <span class="comment">......... Shared UI primitives (9 components)</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">Layout.tsx</span> <span class="comment">...... App shell (sidebar nav, header, content)</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">Field.tsx</span> <span class="comment">....... Form field (input, select, textarea)</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">Section.tsx</span> <span class="comment">..... Collapsible form section</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">RatingRow.tsx</span> <span class="comment">... 0-4 severity rating input</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">Badge.tsx</span> <span class="comment">....... Status badge (approved, denied, etc.)</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">Meter.tsx</span> <span class="comment">....... Visual gauge (probability, hours)</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">Chips.tsx</span> <span class="comment">....... Multi-select tag chips</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">TabBar.tsx</span> <span class="comment">...... Sidebar tab navigation</span><br>
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ <span class="file">StatCard.tsx</span> <span class="comment">.... Metric display card</span><br>
â”‚&nbsp;&nbsp; â””â”€â”€ <span class="dir">features/</span> <span class="comment">........... Feature modules (portal-specific)</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”œâ”€â”€ <span class="dir">auth/</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ <span class="file">LoginScreen.tsx</span> <span class="comment"> Role selection screen</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”œâ”€â”€ <span class="dir">clinic/</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">ClinicPortal.tsx</span> <span class="comment"> Portal shell + tab routing</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">CalculatorTab.tsx</span> <span class="comment"> 7-step assessment form + results panel</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">ClaimsTab.tsx</span> <span class="comment">... Claims list + submission tracking</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ <span class="file">InsightsTab.tsx</span> <span class="comment">. Analytics dashboard</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â””â”€â”€ <span class="dir">insurance/</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”œâ”€â”€ <span class="file">InsurancePortal.tsx</span> <span class="comment"> Portal shell + tab routing</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”œâ”€â”€ <span class="file">QueueTab.tsx</span> <span class="comment">.... Review queue (pending claims)</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”œâ”€â”€ <span class="file">PolicyCalcTab.tsx</span> <span class="comment"> Insurance-side calculator</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”œâ”€â”€ <span class="file">DecisionsTab.tsx</span> <span class="comment">. Decision history</span><br>
â”‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â””â”€â”€ <span class="file">PolicyConfigTab.tsx</span> <span class="comment"> Payer profile editor</span><br>
â”œâ”€â”€ <span class="dir">docs/</span> <span class="comment">................... Documentation</span><br>
â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">ABA_Calculator_Architecture.md</span> <span class="comment">.. Architecture (Markdown)</span><br>
â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">ABA_Calculator_Architecture.html</span> <span class="comment"> Architecture (printable HTML)</span><br>
â”‚&nbsp;&nbsp; â””â”€â”€ <span class="file">ABA_Calculator_User_Guide.html</span> <span class="comment">. Business user guide</span><br>
â”œâ”€â”€ <span class="dir">contracts/</span> <span class="comment">.............. Specification documents</span><br>
â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">ABA_Medical_Necessity_Calculator_Contract.md</span><br>
â”‚&nbsp;&nbsp; â”œâ”€â”€ <span class="file">BUILD_PLAN_REVISED.md</span><br>
â”‚&nbsp;&nbsp; â””â”€â”€ <span class="file">Medical_Software_UI_Design_Contract.md</span><br>
â”œâ”€â”€ <span class="file">vercel.json</span> <span class="comment">............ Vercel deployment config</span><br>
â”œâ”€â”€ <span class="file">vite.config.ts</span> <span class="comment">......... Vite config (React plugin, API proxy)</span><br>
â”œâ”€â”€ <span class="file">tsconfig.json</span> <span class="comment">.......... TypeScript project references</span><br>
â”œâ”€â”€ <span class="file">tsconfig.app.json</span> <span class="comment">...... TS config for frontend</span><br>
â”œâ”€â”€ <span class="file">tsconfig.node.json</span> <span class="comment">..... TS config for backend + Vercel</span><br>
â”œâ”€â”€ <span class="file">package.json</span> <span class="comment">........... Dependencies + scripts</span><br>
â”œâ”€â”€ <span class="file">.env.example</span> <span class="comment">........... Environment variable template</span><br>
â”œâ”€â”€ <span class="file">.gitignore</span> <span class="comment">............. Ignore rules (node_modules, dist, *.db, .env)</span><br>
â””â”€â”€ <span class="file">index.html</span> <span class="comment">............. SPA entry point (Inter font, Vite module)</span>
</div>
</div>

<!-- ===== 4. DUAL-PORTAL ARCHITECTURE ===== -->
<h2>4. Dual-Portal Architecture</h2>
<p>The app serves two distinct user roles through a single codebase with <strong>role-based conditional rendering</strong> (no client-side router needed).</p>

<div class="diagram-box">
  <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 1rem; align-items: start;">
    <div class="tier" style="background: var(--secondary-light); border: 2px solid #80CBC4;">
      <div class="tier-label" style="color: var(--secondary);">ğŸ¥ Clinic Portal</div>
      <div style="font-size: 0.85rem;">
        <p style="margin-bottom: 0.5rem;"><strong>Purpose:</strong> Clinical assessment, dosage calculation, claim submission</p>
        <div class="boxes" style="flex-direction: column;">
          <div class="box"><strong>Calculator Tab</strong><span>7-step assessment form â†’ dosage engine â†’ ML prediction â†’ results panel</span></div>
          <div class="box"><strong>Claims Tab</strong><span>Submit claims from calculator results; view claim history &amp; statuses</span></div>
          <div class="box"><strong>Insights Tab</strong><span>Analytics dashboard: totals, avg hours, approval rates, tier distribution</span></div>
        </div>
      </div>
    </div>

    <div style="text-align: center; padding-top: 2rem;">
      <div style="background: var(--bg); border-radius: 8px; padding: 0.8rem; font-size: 0.8rem; min-width: 100px;">
        <strong>App.tsx</strong><br>
        <span style="color: var(--secondary-text);">Role-based<br>rendering</span><br><br>
        <strong>LoginScreen</strong><br>
        <span style="color: var(--secondary-text);">role = null<br>â†’ Clinic<br>â†’ Insurance</span>
      </div>
    </div>

    <div class="tier" style="background: var(--primary-light); border: 2px solid #90CAF9;">
      <div class="tier-label" style="color: var(--primary);">ğŸ›¡ï¸ Insurance Portal</div>
      <div style="font-size: 0.85rem;">
        <p style="margin-bottom: 0.5rem;"><strong>Purpose:</strong> Claim review, policy calculation, decisions, configuration</p>
        <div class="boxes" style="flex-direction: column;">
          <div class="box"><strong>Queue Tab</strong><span>Pending claims review queue with approve/deny/request-info actions</span></div>
          <div class="box"><strong>Policy Calc Tab</strong><span>Insurance-side calculator using payer profile weights</span></div>
          <div class="box"><strong>Decisions Tab</strong><span>Completed decisions history with notes and timestamps</span></div>
          <div class="box"><strong>Policy Config Tab</strong><span>Edit payer profiles: weights, multipliers, hour ranges</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== 5. 7-STEP DOSAGE ENGINE ===== -->
<h2>5. 7-Step Dosage Calculation Engine</h2>
<p>The core algorithm in <code>src/lib/calculator.ts</code> follows a deterministic 7-step pipeline:</p>

<div class="diagram-box">
  <div class="flow-step"><div class="step-num">1</div><div class="step-content"><strong>FII Composite Score</strong> â€” Sum of 9 functional impairment domains (0â€“4 each) â†’ FII score (0â€“36). Maps to base hours: 0â€“8â†’10h, 9â€“16â†’20h, 17â€“24â†’30h, 25â€“36â†’35h.</div></div>
  <div class="flow-step"><div class="step-num">2</div><div class="step-content"><strong>Vineland-3 Adjustment</strong> â€” Composite adaptive behavior score. Below 70: +8h, 70â€“84: +4h, 85+: +0h. Weighted by payer profile <code>vinW</code>.</div></div>
  <div class="flow-step"><div class="step-num">3</div><div class="step-content"><strong>VB-MAPP Adjustment</strong> â€” Milestones, Barriers, Transitions scores. Milestones below 50: +5h, Barriers above 15: +3h. Weighted by <code>vbW</code>.</div></div>
  <div class="flow-step"><div class="step-num">4</div><div class="step-content"><strong>Behavioral Adjustment</strong> â€” Aggression frequency (+2â€“6h), self-injury severity (+2â€“5h), elopement (+3h), crisis events (+2â€“5h). Weighted by <code>behW</code>.</div></div>
  <div class="flow-step"><div class="step-num">5</div><div class="step-content"><strong>Environmental Modifiers</strong> â€” Each active modifier (school risk, CPS, regression, burnout, etc.) adds +2h. Weighted by <code>envW</code>.</div></div>
  <div class="flow-step"><div class="step-num">6</div><div class="step-content"><strong>Age Multiplier</strong> â€” Age 2â€“6: Ã—1.2 (young), Age 7â€“12: Ã—1.0 (mid), Age 13+: Ã—0.85 (teen). <strong>Overridden to Ã—1.00 for high-risk patients.</strong> Configurable per payer profile.</div></div>
  <div class="flow-step"><div class="step-num">7</div><div class="step-content"><strong>Final Clamping + Derivations</strong> â€” Clamp to payer min/max hours, round to nearest 5. Derive supervision hours (<code>supPct Ã— final</code>), parent training (from <code>ptRange</code>), goal count, risk score. Generate rationale strings.</div></div>
</div>

<div class="diagram-box" style="text-align: center; font-size: 0.85rem; padding: 1rem;">
  <strong>Pipeline Flow:</strong><br><br>
  <span style="background: var(--primary-light); padding: 4px 10px; border-radius: 6px;">FII (9 domains)</span>
  &nbsp;â†’&nbsp;
  <span style="background: var(--primary-light); padding: 4px 10px; border-radius: 6px;">Base Hours</span>
  &nbsp;â†’&nbsp;
  <span style="background: var(--secondary-light); padding: 4px 10px; border-radius: 6px;">+ Vineland Adj</span>
  &nbsp;â†’&nbsp;
  <span style="background: var(--secondary-light); padding: 4px 10px; border-radius: 6px;">+ VB-MAPP Adj</span>
  &nbsp;â†’&nbsp;
  <span style="background: var(--secondary-light); padding: 4px 10px; border-radius: 6px;">+ Behavioral Adj</span>
  &nbsp;â†’&nbsp;
  <span style="background: var(--secondary-light); padding: 4px 10px; border-radius: 6px;">+ Env Adj</span>
  &nbsp;â†’&nbsp;
  <span style="background: var(--warning-light); padding: 4px 10px; border-radius: 6px;">Ã— Age Mult</span>
  &nbsp;â†’&nbsp;
  <span style="background: var(--critical-light); padding: 4px 10px; border-radius: 6px;">Clamp(min, max)</span>
  &nbsp;â†’&nbsp;
  <span style="background: #F3E8FF; padding: 4px 10px; border-radius: 6px; font-weight: 700;">Final Hours + Derivations</span>
</div>

<h3>Tier Assignment</h3>
<table>
  <tr><th>Tier</th><th>Hours</th><th>Name</th><th>Supervision</th><th>Parent Training</th></tr>
  <tr><td><strong>Tier 1</strong></td><td>&lt; 20h</td><td>Focused</td><td>10%</td><td>2h/wk</td></tr>
  <tr><td><strong>Tier 2</strong></td><td>20â€“29h</td><td>Moderate</td><td>15%</td><td>5h/wk</td></tr>
  <tr><td><strong>Tier 3</strong></td><td>30+h</td><td>Intensive</td><td>20%</td><td>8h/wk</td></tr>
</table>

<h3>Clinical Flags</h3>
<table>
  <tr><th>Flag</th><th>Trigger</th><th>System Response</th></tr>
  <tr><td>ğŸ”´ <strong>HIGH RISK</strong></td><td>Risk score â‰¥15/24 or severe self-injury</td><td>Age multiplier overridden to Ã—1.00. Safety plan required.</td></tr>
  <tr><td>ğŸ”´ <strong>Severe Functional Impairment</strong></td><td>FII â‰¥25</td><td>Advisory: consider Tier 3 intensive services</td></tr>
  <tr><td>ğŸŸ  <strong>Significant Behavioral Risk</strong></td><td>Behavioral adjustment â‰¥10</td><td>Behavioral intervention plan required</td></tr>
  <tr><td>ğŸŸ  <strong>Multiple Environmental Stressors</strong></td><td>Environmental adjustment â‰¥6</td><td>Consider wrap-around services</td></tr>
</table>

<!-- ===== 6. ML PREDICTOR ===== -->
<h2>6. Simulated ML Approval Predictor</h2>
<p>The predictor in <code>src/lib/mlPredictor.ts</code> is a <strong>deterministic heuristic</strong> (not actual ML) that estimates approval probability based on data completeness and clinical indicators.</p>

<div class="diagram-box">
  <table>
    <tr><th>Factor</th><th>Logic</th><th>Weight</th></tr>
    <tr><td>Documentation completeness</td><td>% of assessment fields filled</td><td>+30 max</td></tr>
    <tr><td>Clinical severity</td><td>FII score relative to hours requested</td><td>+25 max</td></tr>
    <tr><td>Vineland alignment</td><td>Low composite supports higher hours</td><td>+15 max</td></tr>
    <tr><td>Behavioral justification</td><td>Presence of aggression, SIB, elopement</td><td>+15 max</td></tr>
    <tr><td>Age appropriateness</td><td>Hours align with age expectations</td><td>+10 max</td></tr>
    <tr><td>Environmental factors</td><td>Active modifiers documented</td><td>+5 max</td></tr>
  </table>
  <p style="margin-top: 0.8rem; font-size: 0.85rem;">
    <strong>Output:</strong> Probability (0â€“100%), Confidence (low/medium/high), Tier (likely-approve / borderline / likely-deny), Factor breakdown
  </p>
</div>

<!-- ===== 7. DATABASE SCHEMA ===== -->
<h2>7. Database Schema</h2>
<p>The system uses 4 tables. Locally: <code>server/db/aba.db</code> (SQLite WAL). Cloud: Turso via <code>@libsql/client</code>. Serverless demo: in-memory <code>@libsql/client</code>.</p>

<div class="diagram-box">
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
    <div>
      <h3 style="margin-top: 0;">patients</h3>
      <table>
        <tr><th>Column</th><th>Type</th><th>Notes</th></tr>
        <tr><td><code>id</code></td><td>TEXT PK</td><td>e.g. "P-001"</td></tr>
        <tr><td><code>name</code></td><td>TEXT</td><td>Full name</td></tr>
        <tr><td><code>age</code></td><td>INTEGER</td><td>2â€“21</td></tr>
        <tr><td><code>diagnosis</code></td><td>TEXT</td><td>autism, pdd, aspergers</td></tr>
        <tr><td><code>diagnosis_code</code></td><td>TEXT</td><td>Default F84.0</td></tr>
        <tr><td><code>educational_setting</code></td><td>TEXT</td><td></td></tr>
        <tr><td><code>living_situation</code></td><td>TEXT</td><td></td></tr>
        <tr><td><code>created_at</code></td><td>TEXT</td><td>ISO datetime</td></tr>
      </table>
    </div>
    <div>
      <h3 style="margin-top: 0;">claims</h3>
      <table>
        <tr><th>Column</th><th>Type</th><th>Notes</th></tr>
        <tr><td><code>id</code></td><td>TEXT PK</td><td>UUID</td></tr>
        <tr><td><code>patient_id</code></td><td>TEXT FK</td><td>â†’ patients.id</td></tr>
        <tr><td><code>patient_name</code></td><td>TEXT</td><td>Denormalized</td></tr>
        <tr><td><code>age</code></td><td>INTEGER</td><td>Denormalized</td></tr>
        <tr><td><code>diagnosis</code></td><td>TEXT</td><td>Denormalized</td></tr>
        <tr><td><code>status</code></td><td>TEXT</td><td>submitted â†’ under_review â†’ approved/denied</td></tr>
        <tr><td><code>assessment_data</code></td><td>TEXT</td><td>JSON blob of form inputs</td></tr>
        <tr><td><code>calc_result</code></td><td>TEXT</td><td>JSON blob of engine output</td></tr>
        <tr><td><code>ml_prediction</code></td><td>TEXT</td><td>JSON blob of predictor output</td></tr>
        <tr><td><code>recommended_hours</code></td><td>REAL</td><td>Engine-calculated</td></tr>
        <tr><td><code>approved_hours</code></td><td>REAL</td><td>Set on approval</td></tr>
        <tr><td><code>tier</code></td><td>INTEGER</td><td>1â€“3</td></tr>
        <tr><td><code>review_notes</code></td><td>TEXT</td><td>Reviewer notes</td></tr>
        <tr><td><code>reviewer_id</code></td><td>TEXT</td><td>Reviewer identifier</td></tr>
      </table>
    </div>
    <div>
      <h3 style="margin-top: 0;">payer_profiles</h3>
      <table>
        <tr><th>Column</th><th>Type</th><th>Notes</th></tr>
        <tr><td><code>id</code></td><td>TEXT PK</td><td>e.g. "PP-001"</td></tr>
        <tr><td><code>name</code></td><td>TEXT</td><td>Default, Conservative, Progressive</td></tr>
        <tr><td><code>max/min_hours</code></td><td>REAL</td><td>Clamping range</td></tr>
        <tr><td><code>fii/vin/vb/beh/env_w</code></td><td>REAL</td><td>Domain weights (0â€“2)</td></tr>
        <tr><td><code>age_mult_*</code></td><td>REAL</td><td>young, mid, teen multipliers</td></tr>
        <tr><td><code>sup_pct</code></td><td>REAL</td><td>Supervision %</td></tr>
        <tr><td><code>pt_range_*</code></td><td>REAL</td><td>Parent training min/max</td></tr>
      </table>
    </div>
    <div>
      <h3 style="margin-top: 0;">audit_log</h3>
      <table>
        <tr><th>Column</th><th>Type</th><th>Notes</th></tr>
        <tr><td><code>id</code></td><td>INTEGER PK</td><td>Auto-increment</td></tr>
        <tr><td><code>entity_type</code></td><td>TEXT</td><td>"claim"</td></tr>
        <tr><td><code>entity_id</code></td><td>TEXT</td><td>UUID of entity</td></tr>
        <tr><td><code>action</code></td><td>TEXT</td><td>created, status_approved, etc.</td></tr>
        <tr><td><code>details</code></td><td>TEXT</td><td>JSON details</td></tr>
        <tr><td><code>user_role</code></td><td>TEXT</td><td>clinic / insurance</td></tr>
      </table>
    </div>
  </div>
</div>

<!-- ===== 8. API ENDPOINTS ===== -->
<h2>8. REST API Endpoints</h2>
<div class="diagram-box">
  <table>
    <tr><th>Method</th><th>Endpoint</th><th>Description</th><th>Used By</th></tr>
    <tr><td><code>GET</code></td><td><code>/api/claims</code></td><td>List all claims (sorted by created_at DESC)</td><td>Both portals</td></tr>
    <tr><td><code>GET</code></td><td><code>/api/claims/:id</code></td><td>Get single claim detail</td><td>Both portals</td></tr>
    <tr><td><code>POST</code></td><td><code>/api/claims</code></td><td>Create new claim (assessment + calc + ML data)</td><td>Clinic</td></tr>
    <tr><td><code>PATCH</code></td><td><code>/api/claims/:id/status</code></td><td>Update claim status (approve/deny) + notes</td><td>Insurance</td></tr>
    <tr><td><code>GET</code></td><td><code>/api/patients</code></td><td>List all patients</td><td>Clinic</td></tr>
    <tr><td><code>GET</code></td><td><code>/api/patients/:id</code></td><td>Get single patient</td><td>Clinic</td></tr>
    <tr><td><code>POST</code></td><td><code>/api/patients</code></td><td>Create new patient</td><td>Clinic</td></tr>
    <tr><td><code>GET</code></td><td><code>/api/analytics</code></td><td>Aggregated stats (totals, averages, tier counts)</td><td>Both portals</td></tr>
    <tr><td><code>GET</code></td><td><code>/api/payer-profiles</code></td><td>List all payer profiles</td><td>Insurance</td></tr>
    <tr><td><code>GET</code></td><td><code>/api/payer-profiles/:id</code></td><td>Get single profile</td><td>Insurance</td></tr>
    <tr><td><code>PUT</code></td><td><code>/api/payer-profiles/:id</code></td><td>Update profile weights/ranges</td><td>Insurance</td></tr>
    <tr><td><code>GET</code></td><td><code>/api/health</code></td><td>Health check</td><td>Monitoring</td></tr>
  </table>
</div>

<!-- ===== 9. CLAIMS WORKFLOW ===== -->
<h2>9. End-to-End Claims Workflow</h2>
<p>The complete lifecycle of a claim from clinical assessment to insurance decision:</p>

<div class="diagram-box">
  <div style="display: flex; gap: 0.4rem; align-items: center; flex-wrap: wrap; justify-content: center; font-size: 0.82rem; margin-bottom: 1rem;">
    <span style="background: var(--secondary-light); padding: 6px 14px; border-radius: 8px; border: 2px solid #80CBC4;">1. Fill Assessment</span>
    <span style="color: var(--placeholder);">â†’</span>
    <span style="background: var(--secondary-light); padding: 6px 14px; border-radius: 8px; border: 2px solid #80CBC4;">2. 7-Step Engine</span>
    <span style="color: var(--placeholder);">â†’</span>
    <span style="background: #F3E8FF; padding: 6px 14px; border-radius: 8px; border: 2px solid #D8B4FE;">3. ML Prediction</span>
    <span style="color: var(--placeholder);">â†’</span>
    <span style="background: var(--secondary-light); padding: 6px 14px; border-radius: 8px; border: 2px solid #80CBC4;">4. Review Results</span>
    <span style="color: var(--placeholder);">â†’</span>
    <span style="background: var(--success-light); padding: 6px 14px; border-radius: 8px; border: 2px solid #A5D6A7;">5. Submit Claim</span>
    <span style="color: var(--placeholder);">â†’</span>
    <span style="background: var(--primary-light); padding: 6px 14px; border-radius: 8px; border: 2px solid #90CAF9;">6. Insurance Queue</span>
    <span style="color: var(--placeholder);">â†’</span>
    <span style="background: var(--primary-light); padding: 6px 14px; border-radius: 8px; border: 2px solid #90CAF9;">7. Review + Decide</span>
    <span style="color: var(--placeholder);">â†’</span>
    <span style="background: var(--warning-light); padding: 6px 14px; border-radius: 8px; border: 2px solid #FFD54F;">8. Audit Logged</span>
  </div>

  <div class="two-col" style="font-size: 0.85rem;">
    <div>
      <h3 style="color: var(--secondary);">Clinic Side (Steps 1â€“5)</h3>
      <ol style="padding-left: 1.5rem;">
        <li><strong>CalculatorTab:</strong> Clinician fills patient demographics, FII domains, Vineland scores, VB-MAPP, behavioral data, environmental modifiers, risk assessment</li>
        <li><strong>calculator.ts:</strong> Engine processes all inputs through 7-step pipeline â†’ produces recommended hours, tier, rationale</li>
        <li><strong>mlPredictor.ts:</strong> Analyzes completeness + severity â†’ approval probability + confidence</li>
        <li><strong>Results Panel:</strong> Displays hours, tier, ML prediction, breakdown, clinical flags</li>
        <li><strong>POST /api/claims:</strong> Submits claim (assessment_data, calc_result, ml_prediction as JSON)</li>
      </ol>
    </div>
    <div>
      <h3 style="color: var(--primary);">Insurance Side (Steps 6â€“8)</h3>
      <ol start="6" style="padding-left: 1.5rem;">
        <li><strong>QueueTab:</strong> Claim appears in review queue with status "submitted"</li>
        <li><strong>Review:</strong> Reviewer sees full assessment data, engine results, ML prediction. Can approve, deny, or request more info. Adds review notes.</li>
        <li><strong>PATCH /api/claims/:id/status:</strong> Status updated â†’ audit_log entry created â†’ claim moves to DecisionsTab</li>
      </ol>
    </div>
  </div>
</div>

<!-- ===== 10. STATE FLOW ===== -->
<h2>10. Claim Status State Machine</h2>
<div class="diagram-box" style="text-align: center;">
  <div style="display: flex; gap: 0.5rem; align-items: center; justify-content: center; flex-wrap: wrap; font-size: 0.85rem;">
    <span style="background: var(--primary-light); padding: 8px 16px; border-radius: 8px; border: 2px solid #90CAF9; font-weight: 600;">submitted</span>
    <span style="color: var(--placeholder); font-size: 1.2rem;">â†’</span>
    <span style="background: var(--warning-light); padding: 8px 16px; border-radius: 8px; border: 2px solid #FFD54F; font-weight: 600;">under_review</span>
    <span style="color: var(--placeholder); font-size: 1.2rem;">â†’</span>
    <div style="display: flex; flex-direction: column; gap: 0.4rem;">
      <span style="background: var(--success-light); padding: 8px 16px; border-radius: 8px; border: 2px solid #A5D6A7; font-weight: 600;">approved</span>
      <span style="background: var(--critical-light); padding: 8px 16px; border-radius: 8px; border: 2px solid #EF9A9A; font-weight: 600;">denied</span>
      <span style="background: #FFF3E0; padding: 8px 16px; border-radius: 8px; border: 2px solid #FFCC80; font-weight: 600;">info_requested</span>
    </div>
  </div>
  <p style="margin-top: 1rem; font-size: 0.82rem; color: var(--secondary-text);">Each transition is recorded in <code>audit_log</code> with timestamp, action, details, and user role.</p>
</div>

<!-- ===== 11. DEPLOYMENT ===== -->
<h2>11. Deployment Architecture</h2>

<div class="diagram-box">
  <div class="two-col">
    <div>
      <h3 style="margin-top: 0;">Local Development</h3>
      <div style="font-size: 0.85rem;">
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.8rem; margin-bottom: 0.5rem;">
          <strong>Vite Dev Server</strong> (port 5173)<br>
          <span style="color: var(--secondary-text);">Hot-reload React app, proxies /api/* â†’ :3001</span>
        </div>
        <div style="text-align: center; color: var(--placeholder);">â†• proxy</div>
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.8rem; margin-bottom: 0.5rem;">
          <strong>Express Server</strong> (port 3001)<br>
          <span style="color: var(--secondary-text);">tsx runner, REST API, auto-init DB</span>
        </div>
        <div style="text-align: center; color: var(--placeholder);">â†•</div>
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.8rem;">
          <strong>better-sqlite3</strong><br>
          <span style="color: var(--secondary-text);">Local file: server/db/aba.db (WAL mode)</span>
        </div>
      </div>
    </div>
    <div>
      <h3 style="margin-top: 0;">Vercel Production</h3>
      <div style="font-size: 0.85rem;">
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.8rem; margin-bottom: 0.5rem;">
          <strong>Vercel CDN (Edge)</strong><br>
          <span style="color: var(--secondary-text);">Static dist/ (index.html, JS, CSS) â€” global CDN</span>
        </div>
        <div style="text-align: center; color: var(--placeholder);">â†• /api/* rewrite</div>
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.8rem; margin-bottom: 0.5rem;">
          <strong>Vercel Serverless Function</strong><br>
          <span style="color: var(--secondary-text);">api/index.ts â†’ Express handler (cold-start DB init)</span>
        </div>
        <div style="text-align: center; color: var(--placeholder);">â†• libSQL</div>
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.8rem;">
          <strong>Database (Tri-Mode)</strong><br>
          <span style="color: var(--secondary-text);">TURSO_URL set â†’ Turso Cloud (persistent)<br>TURSO_URL unset â†’ In-memory libSQL (demo, resets on cold start)</span>
        </div>
      </div>
    </div>
  </div>
</div>

<h3>Tri-Mode Database Client</h3>
<p>The <code>server/db/index.ts</code> module provides a unified <code>DbClient</code> interface with three runtime modes:</p>

<div class="diagram-box">
  <table>
    <tr><th>Mode</th><th>When Active</th><th>Technology</th><th>Persistence</th></tr>
    <tr><td><strong>Turso Remote</strong></td><td><code>TURSO_URL</code> env var is set</td><td>@libsql/client over HTTP</td><td>âœ… Full (cloud)</td></tr>
    <tr><td><strong>In-Memory libSQL</strong></td><td>On Vercel (<code>VERCEL=1</code>) without <code>TURSO_URL</code></td><td>@libsql/client with <code>:memory:</code></td><td>âš ï¸ Warm invocations only (demo)</td></tr>
    <tr><td><strong>Local SQLite</strong></td><td>Local dev (no Vercel, no Turso)</td><td>better-sqlite3 file-based</td><td>âœ… Full (local file)</td></tr>
  </table>
</div>

<h3>Environment Variables</h3>
<table>
  <tr><th>Variable</th><th>Required</th><th>Description</th></tr>
  <tr><td><code>TURSO_URL</code></td><td>For persistent cloud DB</td><td>Turso database URL (e.g. <code>libsql://aba-calc-v2-user.turso.io</code>)</td></tr>
  <tr><td><code>TURSO_AUTH_TOKEN</code></td><td>With TURSO_URL</td><td>Turso authentication token</td></tr>
  <tr><td><code>VERCEL</code></td><td>Auto-set by Vercel</td><td>Triggers in-memory fallback when TURSO_URL is absent</td></tr>
</table>

<!-- ===== 12. DATA FLOW ===== -->
<h2>12. Frontend Data Flow</h2>
<div class="diagram-box" style="text-align: center; font-size: 0.85rem;">
  <div style="display: flex; gap: 0.5rem; align-items: center; justify-content: center; flex-wrap: wrap;">
    <span style="background: var(--primary-light); padding: 8px 14px; border-radius: 8px; border: 1px solid #90CAF9;"><strong>React Component</strong><br><span style="font-size: 0.75rem;">e.g. CalculatorTab</span></span>
    <span style="color: var(--placeholder);">â†’ dispatch â†’</span>
    <span style="background: #F3E8FF; padding: 8px 14px; border-radius: 8px; border: 1px solid #D8B4FE;"><strong>Zustand Store</strong><br><span style="font-size: 0.75rem;">claimStore / authStore</span></span>
    <span style="color: var(--placeholder);">â†’ calls â†’</span>
    <span style="background: var(--secondary-light); padding: 8px 14px; border-radius: 8px; border: 1px solid #80CBC4;"><strong>api.ts</strong><br><span style="font-size: 0.75rem;">fetch("/api/*")</span></span>
    <span style="color: var(--placeholder);">â†’ HTTP â†’</span>
    <span style="background: var(--warning-light); padding: 8px 14px; border-radius: 8px; border: 1px solid #FFD54F;"><strong>Express Route</strong><br><span style="font-size: 0.75rem;">server/routes/*</span></span>
    <span style="color: var(--placeholder);">â†’ query â†’</span>
    <span style="background: var(--critical-light); padding: 8px 14px; border-radius: 8px; border: 1px solid #EF9A9A;"><strong>DbClient</strong><br><span style="font-size: 0.75rem;">SQLite / Turso / Memory</span></span>
  </div>
  <p style="margin-top: 1rem; color: var(--secondary-text); font-size: 0.82rem;">
    <strong>Note:</strong> The calculator engine and ML predictor run <em>entirely in the browser</em> (client-side). Only claim persistence uses the API.
  </p>
</div>

<!-- ===== 13. SECURITY NOTES ===== -->
<h2>13. Security &amp; Authentication (Demo Scope)</h2>
<div class="diagram-box" style="font-size: 0.85rem;">
  <table>
    <tr><th>Aspect</th><th>Demo Implementation</th><th>Production Requirement</th></tr>
    <tr><td><strong>Authentication</strong></td><td>Simulated role selection (click to enter)</td><td>OAuth 2.0 / OIDC with JWT tokens</td></tr>
    <tr><td><strong>Authorization</strong></td><td>Role stored in Zustand (client-side only)</td><td>Server-side role enforcement, middleware</td></tr>
    <tr><td><strong>Data Isolation</strong></td><td>Both portals share all data</td><td>Row-level security, tenant isolation</td></tr>
    <tr><td><strong>CORS</strong></td><td>Open (<code>cors()</code> with defaults)</td><td>Restricted to specific origins</td></tr>
    <tr><td><strong>Input Validation</strong></td><td>Minimal client-side checks</td><td>Zod/Joi schemas on all API inputs</td></tr>
    <tr><td><strong>HTTPS</strong></td><td>Local: HTTP, Vercel: HTTPS auto</td><td>Always HTTPS with HSTS</td></tr>
    <tr><td><strong>Audit Logging</strong></td><td>âœ… Functional â€” all status changes logged</td><td>Add user IDs, IP addresses, full request logs</td></tr>
    <tr><td><strong>Rate Limiting</strong></td><td>None</td><td>Express rate-limit middleware</td></tr>
    <tr><td><strong>Data Encryption</strong></td><td>None (SQLite at rest)</td><td>Encryption at rest + in transit</td></tr>
  </table>
</div>

<!-- ===== FOOTER ===== -->
<div style="margin-top: 3rem; padding-top: 1rem; border-top: 2px solid var(--border); color: var(--placeholder); font-size: 0.8rem; text-align: center;">
  ABA Medical Necessity Calculator â€” Architecture Document â€” February 2026 â€” Demo Prototype v2.0
</div>

</body>
</html>
